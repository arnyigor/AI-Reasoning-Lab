### Техническое Задание: Модуль "Демиург" - Генератор Сеттингов для Головоломок

**Версия:** 1.0
**Дата:** 26.05.2024
**Автор:** AI-Аналитик

#### 1. Общее Описание и Цели

**Цель проекта:** Разработать отдельный Python-модуль (`SettingGenerator.py`), именуемый "Демиург", предназначенный для процедурной генерации контентных файлов (`themes.json` и `linguistics.json`).

**Ключевые задачи:**
1.  **Создание Уникальных Сеттингов:** Генерация полностью новых, логически связанных тем для головоломок (категории и их элементы).
2.  **Автоматизация Лингвистики:** Автоматическое формирование базовых лингвистических правил (падежи, шаблоны) для сгенерированных тем.
3.  **Управляемая Случайность:** Обеспечение возможности воспроизводить генерацию с помощью `seed` для тестирования и получения детерминированных результатов.
4.  **Модульность и Расширяемость:** Архитектура модуля должна позволять легко добавлять новые "архетипы" сеттингов (например, "Детектив", "Фэнтези", "Sci-Fi") и новые лингвистические правила.

#### 2. Архитектура и Компоненты

Модуль "Демиург" будет состоять из следующих ключевых компонентов:

**2.1. Класс `SettingGenerator`**

Основной класс, управляющий всем процессом.
*   `__init__(self, seed: int = None)`: Принимает на вход `seed` для инициализации генератора случайных чисел. Если `seed` не указан, используется случайное значение.
*   `generate_setting(self, archetype_name: str, num_categories: int, num_items: int) -> Tuple[dict, dict]`: Главный метод. Принимает на вход имя архетипа ("SciFi", "Fantasy" и т.д.), желаемое количество категорий и элементов, и возвращает два словаря, готовых для записи в `themes.json` и `linguistics.json`.
*   `_generate_theme_name(self, archetype_name: str) -> str`: Вспомогательный метод для генерации названия темы (например, "Тайна на борту 'Цереры'" из архетипа "SciFi").
*   `_save_to_files(self, theme_data: dict, linguistics_data: dict, append: bool = True)`: Метод для сохранения сгенерированных данных в файлы `themes.json` и `linguistics.json`. Параметр `append` позволяет либо перезаписывать файлы, либо дописывать в них новые темы.

**2.2. База Знаний Архетипов (`archetypes.json`)**

Центральный элемент системы. Это будет новый JSON-файл, содержащий "сырой материал" для генерации. Его структура будет выглядеть так:

```json
{
  "SciFi": {
    "theme_templates": [
      "Тайна на борту '{ShipName}'",
      "Загадка колонии '{PlanetName}'",
      "Протокол 'Омега' в секторе {SectorName}"
    ],
    "category_templates": {
      "Персонаж": ["Капитан", "Инженер", "Навигатор", "Медик", "Андроид"],
      "Локация": ["{ShipName}", "{PlanetName}", "{SectorName}"],
      "Технология": ["Имплант", "Гаджет", "Оружие"],
      "Цель": ["Цель миссии", "Груз", "Секретные данные"]
    },
    "word_bank": {
      "ShipName": ["Одиссей", "Прометей", "Андромеда", "Церера", "Титан"],
      "PlanetName": ["Аркадия", "Ксенос-5", "Солярис-2", "Терра-Нова"],
      "SectorName": ["Ориона", "Плеяд", "Центавра"],
      "Имплант": ["Нейро-чип", "Кибер-рука", "Оптический сканер"],
      "Гаджет": ["ЭМИ-граната", "Голо-проектор", "Плазменный резак"]
      // ... и так далее
    }
  },
  "Fantasy": {
    // ... аналогичная структура для фэнтези ...
  }
}
```

**2.3. Лингвистический Движок (`LinguisticEngine`)**

Вспомогательный класс или набор функций для автоматической генерации словаря падежей.

*   `generate_dictionary(self, categories: List[str]) -> dict`: Принимает список названий категорий (например, `["Герой", "Оружие", "Квест"]`) и возвращает готовый словарь для `linguistics.json`.
*   **Логика:** Будет использовать простые эвристики на основе окончаний слов для определения рода и склонения. Для высокой точности можно будет использовать внешнюю библиотеку, например, `pymorphy2`. Это позволит автоматически получать падежи: `Герой -> героя, героем`.

#### 3. Алгоритм Работы `generate_setting`

1.  **Инициализация:** Устанавливается `random.seed(self.seed)`.
2.  **Выбор Архетипа:** Загружаются данные для `archetype_name` из `archetypes.json`.
3.  **Генерация Названия Темы:** Из `theme_templates` выбирается случайный шаблон и заполняется случайными словами из `word_bank`. Результат: `theme_name = "Тайна на борту 'Андромеда'"`.
4.  **Отбор Категорий:**
    *   Из `category_templates` случайным образом выбирается `num_categories` категорий. Например, `["Персонаж", "Локация", "Технология", "Цель"]`.
    *   Для каждой категории выбирается конкретное название из ее списка. Например, для "Технология" может быть выбрано "Имплант".
5.  **Наполнение Категорий:**
    *   Для каждой выбранной категории (например, "Имплант") из `word_bank` случайным образом выбирается `num_items` уникальных элементов (`["Нейро-чип", "Кибер-рука", ...]`).
    *   Формируется финальный словарь для `themes.json`.
6.  **Генерация Лингвистики:**
    *   Список финальных названий категорий передается в `LinguisticEngine`.
    *   `LinguisticEngine` генерирует словарь с падежами.
    *   Добавляются базовые, универсальные шаблоны для `direct_link`, `relative_pos` и т.д.
    *   Формируется финальный словарь для `linguistics.json`.
7.  **Возврат Результата:** Метод возвращает `(theme_data, linguistics_data)`.

#### 4. План Реализации (Дорожная Карта)

**Шаг 1: Создание `archetypes.json` (MVP)**
*   Создать файл `archetypes.json`.
*   Заполнить его одним архетипом, например, "SciFi", перенеся и структурировав туда данные из вашего текущего `themes.json`.

**Шаг 2: Создание `SettingGenerator` (Базовая версия)**
*   Реализовать класс `SettingGenerator` с методами `__init__` и `generate_setting`.
*   Реализовать логику выбора категорий и их наполнения из `archetypes.json`. На этом этапе можно обойтись без генерации лингвистики, возвращая пустой словарь.

**Шаг 3: Интеграция Лингвистического Движка**
*   **Вариант А (Простой):** Написать простую функцию, которая работает по правилам (если слово заканчивается на согласную - мужской род, на "а" - женский и т.д.) и формирует падежи по шаблонам.
*   **Вариант Б (Продвинутый):** Интегрировать библиотеку `pymorphy2` (`pip install pymorphy2`). Это даст грамматически почти идеальные результаты с минимальными усилиями. Рекомендуется этот вариант.
*   `generate_dictionary` должен вызывать `pymorphy2` для получения нужных падежей.

**Шаг 4: Реализация Сохранения и Финальная Интеграция**
*   Реализовать метод `_save_to_files`.
*   Создать новый скрипт `generate_settings.py`, который будет использовать `SettingGenerator` для наполнения ваших `.json` файлов.

```python
# Пример использования в generate_settings.py
from SettingGenerator import SettingGenerator

if __name__ == "__main__":
    # Генерируем новый Sci-Fi сеттинг с seed для воспроизводимости
    demiurge = SettingGenerator(seed=42)
    
    sci_fi_theme, sci_fi_ling = demiurge.generate_setting(
        archetype_name="SciFi",
        num_categories=8,
        num_items=10
    )
    
    # Добавляем его в существующие файлы
    demiurge.save_to_files(sci_fi_theme, sci_fi_ling, append=True)
    
    print(f"Новый сеттинг '{list(sci_fi_theme.keys())[0]}' успешно сгенерирован и добавлен!")
```

#### 5. Ожидаемые Результаты

*   **Автономность:** Возможность генерировать неограниченное количество разнообразных сеттингов для головоломок одной командой.
*   **Качество:** Сгенерированные головоломки будут иметь осмысленные, тематически связанные категории и элементы, а также корректное лингвистическое оформление.
*   **Воспроизводимость:** Любой сгенерированный сеттинг можно будет получить заново, указав тот же `seed`.

### Генерация
```bash
python -m grandmaster.src.populate_themes
```

### Философия Промпта: "Мышление в Формате JSON"

Чтобы получить от LLM качественный результат, мы не будем просить ее "придумать что-то". Мы дадим ей:
1.  **Роль:** Мы попросим ее вести себя как сценарист и разработчик игр.
2.  **Четкую Цель:** Создать контент для процедурной генерации.
3.  **Строгую Структуру Вывода:** Мы предоставим ей точный шаблон JSON, который она должна заполнить.
4.  **Конкретные Инструкции и Ограничения:** Мы укажем количество элементов, стиль названий и другие важные детали.
5.  **Пример "Хорошего Результата":** Мы покажем ей уже существующий архетип "Fantasy" в качестве идеального примера для подражания.

Это заставит модель "мыслить" в нужном нам формате и минимизирует вероятность ошибок.

---

### Промпт для Генерации Новых Архетипов

Ниже представлен универсальный промпт. Вы можете просто скопировать его и вставить в любую современную LLM (ChatGPT-4, Claude 3, Gemini и т.д.). В квадратных скобках `[ ... ]` я указал места, которые вы можете легко изменять для генерации разных архетипов.

---

#### **< НАЧАЛО ПРОМПТА >**

**РОЛЬ:**
Ты — опытный сценарист и разработчик нарративных игр, специализирующийся на создании контента для систем процедурной генерации. Твоя задача — создавать "архетипы" миров, которые будут служить основой для генерации логических головоломок.

**ЦЕЛЬ:**
Создать новый архетип для файла `archetypes.json` на заданную тему. Архетип должен содержать шаблоны названий, группы категорий и обширный "банк слов" для наполнения этих категорий.

**ТЕМА ДЛЯ НОВОГО АРХЕТИПА:**
[**Викторианский детектив в Лондоне**]

**СТРОГИЕ ИНСТРУКЦИИ ПО ФОРМАТУ ВЫВОДА:**
Твой ответ должен быть **исключительно в формате JSON**. Не добавляй никакого текста до или после JSON-блока. Структура JSON должна в точности соответствовать следующему шаблону:

```json
{
  "НАЗВАНИЕ_АРХЕТИПА": {
    "theme_templates": [],
    "category_templates": {},
    "word_bank": {}
  }
}
```

**ПОШАГОВЫЕ ТРЕБОВАНИЯ К ЗАПОЛНЕНИЮ:**

1.  **НАЗВАНИЕ_АРХЕТИПА:**
    *   Придумай короткое и емкое название на английском языке в стиле CamelCase. Для темы "Викторианский детектив" подойдет, например, `VictorianMystery`.

2.  **`theme_templates` (Шаблоны названий тем):**
    *   Создай **5-8** разнообразных шаблона для генерации названий головоломок.
    *   Внутри шаблонов используй плейсхолдеры в фигурных скобках `{Ключ}`.
    *   Ключи должны соответствовать ключам из `word_bank`.
    *   **Пример:** `"Дело о пропавшем артефакте '{Артефакт}'"`

3.  **`category_templates` (Шаблоны категорий):**
    *   Создай **6-8** "абстрактных" групп категорий (ключи этого словаря). Например: "Персонаж", "Место", "Улика", "Мотив".
    *   Для каждой группы придумай **1-2** конкретных названия категорий (значения в виде списка). Например, для "Персонажа" это могут быть `["Детектив", "Подозреваемый"]`.
    *   **Важно:** Каждое конкретное название категории должно иметь соответствующий ключ в `word_bank`!

4.  **`word_bank` (Банк слов):**
    *   Это самая важная часть. Наполни его данными для **каждого** ключа, который ты использовал в `theme_templates` и `category_templates`.
    *   Для каждой категории создай список из **10-12** уникальных, тематически подходящих элементов.
    *   Используй яркие, атмосферные названия, соответствующие эпохе.
    *   **Ключи в `word_bank` не должны содержать пробелов!** Используй CamelCase или `under_score`. Например, `МестоПреступления`, а не `Место преступления`.

**ПРИМЕР ИДЕАЛЬНОГО РЕЗУЛЬТАТА (ИСПОЛЬЗУЙ КАК ОБРАЗЕЦ СТИЛЯ И СТРУКТУРЫ):**

```json
{
  "Fantasy": {
    "theme_templates": [
      "Квест на '{Квест}'",
      "Тайна гильдии '{Класс}'",
      "Поиски оружия '{Оружие}' в {Место_в_мире}"
    ],
    "category_templates": {
      "Протагонист": ["Герой"],
      "Специализация": ["Класс", "Ранг_в_гильдии"],
      "Экипировка": ["Оружие"],
      "Задача": ["Квест"],
      "Спутник": ["Питомец"],
      "Локация": ["Место_в_мире"]
    },
    "word_bank": {
      "Герой": ["Торгрим", "Элара", "Ричард", "Селена", "Гром", "Лиара", "Флинн", "Бриенна", "Кайден", "Изольда"],
      "Класс": ["Воин", "Маг", "Лучник", "Разбойник", "Жрец", "Паладин", "Друид", "Некромант", "Бард", "Варвар"],
      "Оружие": ["Двуручный меч", "Магический посох", "Длинный лук", "Парные кинжалы", "Священный молот", "Боевой топор", "Сияющий клинок", "Посох из лозы"],
      "Квест": ["Убить дракона", "Найти древний артефакт", "Защитить деревню", "Раскрыть заговор", "Спасти принцессу", "Очистить подземелье", "Сопроводить караван"],
      "Ранг_в_гильдии": ["Бронза", "Серебро", "Золото", "Платина", "Мифрил", "Адамантит", "Эфириум", "Легенда"],
      "Питомец": ["Волк", "Сокол", "Грифон", "Дрейк", "Элементаль", "Виверна", "Боевой кабан", "Призрак"],
      "Место_в_мире": ["Эльфийский лес", "Гномьи пещеры", "Драконьи горы", "Болота нежити", "Руины древних", "Столица Империи", "Портовый город", "Волшебная академия"]
    }
  }
}
```

Теперь приступай к генерации нового архетипа на тему, указанную выше. Помни, твой ответ должен быть только валидным JSON.

#### **< КОНЕЦ ПРОМПТА >**

---

### Как Использовать и Модифицировать Промпт

1.  **Скопируйте и вставьте:** Просто скопируйте весь текст выше в окно чата с LLM.
2.  **Измените Тему:** Самое простое — поменять строку `[**Викторианский детектив в Лондоне**]` на что-то другое. Например:
    *   `[**Шпионский триллер времен Холодной войны**]`
    *   `[**Выживание в постапокалиптической пустоши**]`
    *   `[**Политическая интрига в Римской Империи**]`
3.  **Получите Результат:** Модель сгенерирует JSON-блок.
4.  **Проверьте и Вставьте:** Внимательно просмотрите сгенерированный JSON на предмет логических несоответствий или ошибок формата (хотя с таким промптом их будет минимум). Затем скопируйте его и вставьте в ваш файл `archetypes.json`, добавив запятую после предыдущего архетипа.
